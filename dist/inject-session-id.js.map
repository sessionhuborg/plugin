{
  "version": 3,
  "sources": ["../src/inject-session-id.ts"],
  "sourcesContent": ["#!/usr/bin/env node\n/**\n * SessionHub Session ID Injection Hook\n *\n * This hook runs on SessionStart to:\n * 1. Check if SessionHub is configured (API key present)\n * 2. Inject the session ID into Claude's context for parallel session support\n * 3. Persist SESSIONHUB_PROJECT_DIR to CLAUDE_ENV_FILE for slash commands\n *\n * The hook fails gracefully - if anything fails, it allows the session to start normally.\n */\n\nimport { stdin } from 'process';\nimport fs from 'fs';\nimport path from 'path';\nimport { homedir } from 'os';\n\n// Ensure ~/.sessionhub directory exists before any operations\nconst sessionhubDir = path.join(homedir(), '.sessionhub');\ntry {\n  fs.mkdirSync(sessionhubDir, { recursive: true });\n} catch {\n  // Silently fail - may not have permissions\n}\n\n/**\n * Escape special shell characters for safe use in double-quoted strings\n * Prevents shell injection when writing to env files\n */\nfunction escapeShellString(str: string): string {\n  // Remove newlines/carriage returns to prevent line injection attacks\n  // Then escape: backslash, double-quote, dollar sign, backtick\n  return str.replace(/[\\n\\r]/g, '').replace(/[\\\\\"`$]/g, '\\\\$&');\n}\n\n/**\n * Validate that a string is a valid UUID format\n * Prevents injection attacks via malformed session IDs\n */\nfunction isValidUUID(str: string): boolean {\n  // UUID v4 format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n  return uuidRegex.test(str);\n}\n\ninterface HookInput {\n  session_id?: string;\n  cwd?: string;\n}\n\ninterface Config {\n  user: { apiKey: string };\n}\n\n/**\n * Check if SessionHub is configured with an API key\n */\nfunction checkConfig(): { configured: boolean; error?: string } {\n  try {\n    const configPath = path.join(homedir(), '.sessionhub', 'config.json');\n    if (!fs.existsSync(configPath)) {\n      return { configured: false, error: 'SessionHub is not configured yet.' };\n    }\n\n    const configData = fs.readFileSync(configPath, 'utf-8');\n    const config: Config = JSON.parse(configData);\n    const apiKey = config?.user?.apiKey;\n\n    if (!apiKey) {\n      return { configured: false, error: 'SessionHub API key is not set.' };\n    }\n\n    return { configured: true };\n  } catch {\n    return { configured: false, error: 'Could not read SessionHub config.' };\n  }\n}\n\n/**\n * Read stdin for hook input\n */\nasync function readStdin(): Promise<HookInput> {\n  // Check if running in TTY mode (for testing)\n  if (stdin.isTTY) {\n    return { cwd: process.cwd() };\n  }\n\n  let inputData = '';\n  for await (const chunk of stdin) {\n    inputData += chunk;\n  }\n\n  if (inputData.trim()) {\n    try {\n      return JSON.parse(inputData);\n    } catch {\n      return { cwd: process.cwd() };\n    }\n  }\n\n  return { cwd: process.cwd() };\n}\n\n/**\n * Main execution function\n */\nasync function main(): Promise<void> {\n  try {\n    // Read stdin for session metadata\n    const hookInput = await readStdin();\n    const sessionId = hookInput.session_id;\n    const projectDir = process.env.CLAUDE_PROJECT_DIR || hookInput.cwd || process.cwd();\n\n    // Check if SessionHub is configured\n    const { configured } = checkConfig();\n\n    // Persist project directory to env file for slash commands\n    const envFile = process.env.CLAUDE_ENV_FILE;\n    if (envFile && projectDir) {\n      try {\n        // Escape shell special characters to prevent injection\n        const escapedPath = escapeShellString(projectDir);\n        fs.appendFileSync(envFile, `export SESSIONHUB_PROJECT_DIR=\"${escapedPath}\"\\n`);\n      } catch {\n        // Silently fail - don't block session start\n      }\n    }\n\n    // Build the context message\n    const contextParts: string[] = [];\n\n    // Add setup warning if not configured\n    if (!configured) {\n      contextParts.push(\n        '**SessionHub Setup Required**: Run `/setup <your-api-key>` to enable session capture. ' +\n        'Get your API key at https://sessionhub.dev/settings'\n      );\n    }\n\n    // Add session tracking info (only if valid UUID format)\n    // Security: Validate session ID format to prevent injection attacks\n    if (sessionId && isValidUUID(sessionId)) {\n      contextParts.push(\n        `[SESSIONHUB_SESSION_ID:${sessionId}] [SESSIONHUB_PROJECT_DIR:${projectDir}]`\n      );\n    }\n\n    // Output the context if we have any\n    if (contextParts.length > 0) {\n      console.log(JSON.stringify({\n        hookSpecificOutput: {\n          hookEventName: 'SessionStart',\n          additionalContext: contextParts.join(' | ')\n        }\n      }));\n    }\n  } catch {\n    // Silently fail - don't block session start\n  }\n}\n\n// Run main function\nmain();\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAYA,qBAAsB;AACtB,gBAAe;AACf,kBAAiB;AACjB,gBAAwB;AAGxB,IAAM,gBAAgB,YAAAA,QAAK,SAAK,mBAAQ,GAAG,aAAa;AACxD,IAAI;AACF,YAAAC,QAAG,UAAU,eAAe,EAAE,WAAW,KAAK,CAAC;AACjD,QAAQ;AAER;AAMA,SAAS,kBAAkB,KAAqB;AAG9C,SAAO,IAAI,QAAQ,WAAW,EAAE,EAAE,QAAQ,YAAY,MAAM;AAC9D;AAMA,SAAS,YAAY,KAAsB;AAEzC,QAAM,YAAY;AAClB,SAAO,UAAU,KAAK,GAAG;AAC3B;AAcA,SAAS,cAAuD;AAC9D,MAAI;AACF,UAAM,aAAa,YAAAD,QAAK,SAAK,mBAAQ,GAAG,eAAe,aAAa;AACpE,QAAI,CAAC,UAAAC,QAAG,WAAW,UAAU,GAAG;AAC9B,aAAO,EAAE,YAAY,OAAO,OAAO,oCAAoC;AAAA,IACzE;AAEA,UAAM,aAAa,UAAAA,QAAG,aAAa,YAAY,OAAO;AACtD,UAAM,SAAiB,KAAK,MAAM,UAAU;AAC5C,UAAM,SAAS,QAAQ,MAAM;AAE7B,QAAI,CAAC,QAAQ;AACX,aAAO,EAAE,YAAY,OAAO,OAAO,iCAAiC;AAAA,IACtE;AAEA,WAAO,EAAE,YAAY,KAAK;AAAA,EAC5B,QAAQ;AACN,WAAO,EAAE,YAAY,OAAO,OAAO,oCAAoC;AAAA,EACzE;AACF;AAKA,eAAe,YAAgC;AAE7C,MAAI,qBAAM,OAAO;AACf,WAAO,EAAE,KAAK,QAAQ,IAAI,EAAE;AAAA,EAC9B;AAEA,MAAI,YAAY;AAChB,mBAAiB,SAAS,sBAAO;AAC/B,iBAAa;AAAA,EACf;AAEA,MAAI,UAAU,KAAK,GAAG;AACpB,QAAI;AACF,aAAO,KAAK,MAAM,SAAS;AAAA,IAC7B,QAAQ;AACN,aAAO,EAAE,KAAK,QAAQ,IAAI,EAAE;AAAA,IAC9B;AAAA,EACF;AAEA,SAAO,EAAE,KAAK,QAAQ,IAAI,EAAE;AAC9B;AAKA,eAAe,OAAsB;AACnC,MAAI;AAEF,UAAM,YAAY,MAAM,UAAU;AAClC,UAAM,YAAY,UAAU;AAC5B,UAAM,aAAa,QAAQ,IAAI,sBAAsB,UAAU,OAAO,QAAQ,IAAI;AAGlF,UAAM,EAAE,WAAW,IAAI,YAAY;AAGnC,UAAM,UAAU,QAAQ,IAAI;AAC5B,QAAI,WAAW,YAAY;AACzB,UAAI;AAEF,cAAM,cAAc,kBAAkB,UAAU;AAChD,kBAAAA,QAAG,eAAe,SAAS,kCAAkC,WAAW;AAAA,CAAK;AAAA,MAC/E,QAAQ;AAAA,MAER;AAAA,IACF;AAGA,UAAM,eAAyB,CAAC;AAGhC,QAAI,CAAC,YAAY;AACf,mBAAa;AAAA,QACX;AAAA,MAEF;AAAA,IACF;AAIA,QAAI,aAAa,YAAY,SAAS,GAAG;AACvC,mBAAa;AAAA,QACX,0BAA0B,SAAS,6BAA6B,UAAU;AAAA,MAC5E;AAAA,IACF;AAGA,QAAI,aAAa,SAAS,GAAG;AAC3B,cAAQ,IAAI,KAAK,UAAU;AAAA,QACzB,oBAAoB;AAAA,UAClB,eAAe;AAAA,UACf,mBAAmB,aAAa,KAAK,KAAK;AAAA,QAC5C;AAAA,MACF,CAAC,CAAC;AAAA,IACJ;AAAA,EACF,QAAQ;AAAA,EAER;AACF;AAGA,KAAK;",
  "names": ["path", "fs"]
}
